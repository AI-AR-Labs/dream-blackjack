name: AI Development Workflow V2

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number

jobs:
  ai-development:
    if: github.event.label.name == 'ai-ready' || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Install Node dependencies
        run: npm ci
      
      - name: Debug Environment
        run: |
          echo "BOT_TOKEN exists: ${{ secrets.BOT_TOKEN != '' }}"
          echo "GITHUB_TOKEN: ${{ github.token != '' }}"
          echo "Workflow triggered by: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
      
      - name: Debug Token Permissions
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          echo "Testing BOT_TOKEN..."
          if [ -z "$BOT_TOKEN" ]; then
            echo "ERROR: BOT_TOKEN is empty!"
          else
            echo "BOT_TOKEN is set (length: ${#BOT_TOKEN})"
          fi
      
      - name: Extract Issue Details
        id: issue
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          # Use direct API call with BOT_TOKEN
          RESPONSE=$(curl -s -H "Authorization: token $BOT_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
          
          # Extract issue data
          ISSUE_TITLE=$(echo "$RESPONSE" | jq -r '.title')
          ISSUE_BODY=$(echo "$RESPONSE" | jq -r '.body')
          
          # Extract acceptance criteria
          CRITERIA=$(echo "$ISSUE_BODY" | awk '/## Acceptance Criteria/{flag=1; next} /^##/{flag=0} flag')
          
          # Save to files
          echo "Issue #$ISSUE_NUMBER: $ISSUE_TITLE" > issue-context.txt
          echo "" >> issue-context.txt
          echo "$ISSUE_BODY" >> issue-context.txt
          echo "$CRITERIA" > acceptance-criteria.txt
          
          # Set outputs
          echo "criteria<<EOF" >> $GITHUB_OUTPUT
          echo "$CRITERIA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Create Feature Branch
        run: |
          BRANCH_NAME="feature/issue-${{ steps.issue.outputs.issue_number }}"
          git checkout -b $BRANCH_NAME
          
      - name: Generate Tests with Claude
        run: |
          # Create prompt for test generation
          cat > generate-tests-prompt.txt << 'EOF'
          Read the acceptance criteria from acceptance-criteria.txt and generate comprehensive tests for each criterion.
          
          Follow these guidelines:
          1. Create a new test file in the tests/ directory
          2. Each acceptance criterion should have at least one test
          3. Tests should fail initially (since no implementation exists yet)
          4. Use descriptive test names
          5. Follow the existing test patterns in the codebase
          
          The tests should be thorough and cover edge cases.
          EOF
          
          # Run Claude to generate tests
          claude < generate-tests-prompt.txt
          
      - name: Implement Feature with Claude
        run: |
          # Create prompt for implementation
          cat > implement-feature-prompt.txt << 'EOF'
          Implement the feature to make all tests pass. Follow these steps:
          
          1. Run npm test to see which tests are failing
          2. Implement the minimal code needed to make tests pass
          3. Run tests again to verify
          4. Repeat until all tests pass
          5. Ensure code follows project conventions in CLAUDE.md
          6. Do not modify the tests unless they have errors
          
          Keep running tests and fixing issues until all tests pass.
          EOF
          
          # Run Claude to implement the feature
          claude < implement-feature-prompt.txt
          
      - name: Run Final Tests
        run: npm test
        
      - name: Generate Test Report
        if: always()
        run: npm run test:coverage -- --json --outputFile=test-results.json
        
      - name: Commit Changes
        run: |
          git config user.email "robottonik@users.noreply.github.com"
          git config user.name "robottonik"
          git add -A
          git commit -m "Implement feature for issue #${{ steps.issue.outputs.issue_number }}"
          
      - name: Push Changes
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          git remote set-url origin https://robottonik:${BOT_TOKEN}@github.com/${{ github.repository }}.git
          git push origin "feature/issue-${{ steps.issue.outputs.issue_number }}"
          
      - name: Deploy to Dev Environment
        id: deploy
        run: |
          # Deploy to dev environment and get URL
          echo "deployment_url=https://dev-${{ steps.issue.outputs.issue_number }}.example.com" >> $GITHUB_OUTPUT
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: "feature/issue-${{ steps.issue.outputs.issue_number }}"
          title: "Implement feature for issue #${{ steps.issue.outputs.issue_number }}"
          body: |
            ## Summary
            Implemented feature as requested in issue #${{ steps.issue.outputs.issue_number }}
            
            ## Test Results
            All tests passing âœ…
            [View test report](./test-results.json)
            
            ## Deployment
            ðŸš€ [Dev deployment](${{ steps.deploy.outputs.deployment_url }})
            
            ## Acceptance Criteria
            ${{ steps.issue.outputs.criteria }}
            
            ---
            *This PR was automatically generated by Claude*